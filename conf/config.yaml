# @package _global_

defaults:
  - _self_
  - dataset: shank3  # Options: markerless, shank3, custom
  - preprocess: opencv  # Options: opencv, sam (future)
  - optim: fast  # Options: fast, accurate
  - frames: default  # Options: default (100), debug (5), full (1000)
  - experiment: null  # Optional: quick_test, full_run, etc.
  - override hydra/job_logging: default
  - override hydra/hydra_logging: default

# Global settings
mode: multi_view  # Options: multi_view, single_view_preprocess

# Data settings (can be overridden by dataset config or --input_dir CLI argument)
# NOTE: Use relative paths or override with --input_dir for portability across servers
data:
  data_dir: data/examples/markerless_mouse_1_nerf/  # Default example dataset (override with --input_dir)
  views_to_use: [0]

# Preprocessing settings (can be overridden by preprocess config)
preprocess:
  input_video_path: data/shank3/100-KO-male-56-20200615.avi
  output_data_dir: data/preprocessed_shank3/

# Fitter settings
fitter:
  start_frame: 0
  end_frame: 2
  interval: 1
  resume: false
  with_render: false
  keypoint_num: 22
  render_cameras: [0]
  use_keypoints: true  # Set to false to disable keypoint loss (silhouette only)

  # Debug iteration visualization mode
  # Options: "first_last" (default), "all", "none"
  debug_iter_mode: "first_last"  # Only save first and last iteration images

  # Post-fitting visualization settings (auto-generated after fitting)
  generate_visualizations: true  # Generate videos/report after fitting
  create_videos: true            # Create mesh, keypoint, overlay videos
  create_report: true            # Create HTML report
  create_summary: true           # Create summary frame image
  video_fps: 30                  # Video frame rate

# Silhouette-only mode settings (only used when use_keypoints=false)
silhouette:
  # Iteration multiplier for silhouette-only mode (1.0 = same as keypoint mode)
  iter_multiplier: 2.0
  # Theta (pose) regularization weight (higher = less pose variation)
  theta_weight: 10.0  # Default with keypoints is 3.0
  # Bone length regularization weight
  bone_weight: 2.0  # Default is 0.5
  # Scale regularization weight
  scale_weight: 50.0  # Default is 0.5
  # Use mask PCA for initial rotation estimation
  use_pca_init: true

# Optimization settings (can be overridden by optim config)
optim:
  solve_step0_iters: 10
  solve_step1_iters: 100
  solve_step2_iters: 30

# Loss weights (original MAMMAL paper values)
loss_weights:
  # Base weights
  theta: 3.0           # Pose prior regularization
  "3d": 2.5            # 3D keypoint loss (if GT available)
  "2d": 0.2            # 2D keypoint reprojection loss
  bone: 0.5            # Bone length regularization
  scale: 0.5           # Scale regularization
  chest_deformer: 0.1  # Chest deformation regularization
  stretch: 1.0         # Stretch constraint (set to 0 during optimization)
  temp: 0.25           # Temporal smoothness (params)
  temp_d: 0.2          # Temporal smoothness (deformer)

  # Mask (silhouette) loss weights per step
  # Original MAMMAL: step0/step1 = 0 (keypoint-guided), step2 = 3000
  mask_step0: 0.0      # Step0: global pose (R,T,s) - no mask
  mask_step1: 0.0      # Step1: pose optimization - no mask
  mask_step2: 3000.0   # Step2: full optimization with silhouette refinement

# Keypoint weights (per-keypoint confidence)
keypoint_weights:
  default: 1.0
  idx_4: 0.4           # Lower confidence
  idx_5: 2.0           # Higher confidence (important joint)
  idx_6: 1.5
  idx_7: 1.5
  idx_11: 0.9
  idx_15: 0.9
  # Tail keypoints (16-21) get weight=10 in step2
  tail_step2: 10.0

# Paths (all results go to results/ folder)
result_folder: results/fitting/

# Hydra configuration
hydra:
  run:
    dir: results/logs/${now:%Y-%m-%d}/${now:%H-%M-%S}
  job:
    chdir: false  # Important: Do not change working directory
